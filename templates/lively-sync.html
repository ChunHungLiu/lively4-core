<template id="lively-sync">
    <style>
    .container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding-left: 20px;
    }
    p {
      margin-top: 5px;
      margin-bottom: 5px;      
    }
    }
    </style>
    <div class="container">
      <h2>Sync Github</h2>
        <p><button id="loginButton">not initialize</button> username: <input id="gitusername" value="" /></p>
        <p><button id="syncButton">sync</button> repository: <input id="gitrepository" value="lively4-core" /></p>

        <pre id="log"></pre>  
    </div>

    <script type="lively4script" data-name="initialize">
    () => {
      var container = $(this.shadowRoot).find(".container")[0];
      lively.html.registerButtons(this)
      this.updateLoginStatus()
    }
    </script>
    <script type="lively4script" data-name="onSyncButton">
    async () => {
      var username = await lively.focalStorage.getItem("githubUsername")
      var token = await lively.focalStorage.getItem("githubToken")
      var serverURL = lively4url.match(/(.*)\/([^\/]+$)/)[1]
      var repo =  this.shadowRoot.querySelector("#gitrepository").value
      lively.files.syncRepository(serverURL, repo, username, token).then(this.log)
    }
    </script>
    
    <script type="lively4script" data-name="log">
    (s) => {
      this.shadowRoot.querySelector("#log").innerHTML = "" + s
    }
    </script>
    
    <script type="lively4script" data-name="updateLoginStatus">
    async () => {
      var token = await lively.focalStorage.getItem("githubToken")
      this.shadowRoot.querySelector("#loginButton").innerHTML = 
          token ? "logout" : "login"
      this.shadowRoot.querySelector("#syncButton").disabled = 
        token ? false : true;
      this.shadowRoot.querySelector("#gitusername").value = 
       await lively.focalStorage.getItem("githubUsername")
    }
    </script>
    
    <script type="lively4script" data-name="onLoginButton">
    async () => {
      if (await lively.focalStorage.getItem("githubToken")) { 
        this.logout() 
      } else { 
        this.login()
      }
    }
    </script>
    <script type="lively4script" data-name="login">
    () => {
      lively.focalStorage.getItem("githubToken").then((result) => {
        if (result) return result
        return new Promise((resolve, reject) => {
          lively.authGithub.challengeForAuth(Date.now(), (token) => {  
        	  lively.focalStorage.setItem("githubUsername", 
        	    this.shadowRoot.querySelector("#gitusername").value)
        	  lively.focalStorage.setItem("githubToken", token)
        	  this.updateLoginStatus()
        	  resolve(token)
          })
        })
      }).then((token) => {
        this.log("TOKEN: " + token)
      })
    }
    </script>
    <script type="lively4script" data-name="logout">
    () => {
    	lively.focalStorage.setItem("githubToken", null)    
      lively.focalStorage.setItem("githubUsername", null)
      this.updateLoginStatus()
      this.log("")
    }
    </script>
    
</template>

<script class="registrationScript">lively.registerTemplate()</script>
