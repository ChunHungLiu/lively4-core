<template id="lively-container">
    <content></content>
    <style>

    </style>
    <script type="lively4script" data-name="initialize">
    () => {

      window.onpopstate = (event) => {
        var state = event.state
        if (state && state.followInline) {
          console.log("follow " + state.path)
          this.setPath(state.path)
        }
      };
    }
    </script>
    <script type="lively4script" data-name="clear">
    () => {
        this.innerHTML = ''
    }
    </script>

    <script type="lively4script" data-name="appendMarkdown">
    (content) => {
      var fixLinks = (nodes) => {
        if (! nodes) return
        Array.prototype.forEach.call(nodes, node => {
          if (node.getAttribute) {
            var href = node.getAttribute("href")
            if (href) {
              console.log("fix " + href)
              // #TODO load inplace....
              var path
              if (href.match(/^\//)) {
                  path = href // ABSOLTUE paths
              } else if (!href.match(/!([A-Za-z]+):\/\/.+/)) { // ignore FULL URLS
                  path = this.getDir() + href // that leaves us RELATIVE paths
              }
              if (path) {
                console.log("fix "  + path)
                $(node).click(() => { this.followPath(path); return false; });

                // ALTERNATIVE to navigate it inline, but the link will not be followed....
                // var link = lively4url + "/draft/start.html?load=" + path
                // node.setAttribute("href", link)
              } else {
                console.log("ignore " + href)
              }
            }
            fixLinks(node.childNodes)
          }
        })
      }
      System.import('../src/external/showdown.js').then((showdown) => {
        var converter = new showdown.Converter();
        var htmlSource = converter.makeHtml(content)
        var html = $.parseHTML(htmlSource)
        fixLinks(html)
        console.log("html", html)
        html.forEach((ea) => this.appendChild(ea))
      })
    }
    </script>
     <script type="lively4script" data-name="appendHtml">
    (content) => {
      try {
        $.parseHTML(content).forEach((ea) => this.appendChild(ea))
      } catch(e) {
        console.log("Could not append html:" + content)
      }
    }
    </script>
    <script type="lively4script" data-name="getDir">
    () => {
         return this.getPath().replace(/[^/]*$/,"")
    }
    </script>
    <script type="lively4script" data-name="followPath">
    (path) => {
        window.history.pushState({ followInline: true, path: path }, 'view ' + path, window.location.pathname + "?load="+path);
        this.setPath(path)
    }
    </script>
    <script type="lively4script" data-name="getPath">
    () => {
         return this.getAttribute("data-path")
    }
    </script>
    <script type="lively4script" data-name="setPath">
    (path) => {
      this.setAttribute("data-path", path)
      this.clear()
      $.get("https://lively4/" + path, (content) => {
        var format = path.replace(/.*\./,"")
        if (format == "html")  {
          this.appendHtml(content)
        } else if (format == "md") {
          this.appendMarkdown(content)
        } else {
          this.appendHtml("<pre>" + content +"</pre>")
        }

      }).fail(function(err){
          console.log("Could not load: " + path)
      })
    }
    </script>
     <script type="lively4script" data-name="appendHTML">
    (content) => {
        $.parseHTML(content).forEach((ea) => this.appendChild(ea))
    }
    </script>


</template>
<script class="registrationScript">
// This ugly piece of code will be auto generated, when exporting a template. Puh.
(function() {
  var template = document.currentScript.ownerDocument.querySelector('#lively-container');
  var clone = document.importNode(template.content, true);

  System.import('../src/client/morphic/component-loader.js').then(loader => { loader.register('lively-container', clone); });
})();
</script>
