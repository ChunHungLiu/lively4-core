<link rel="import" href="lively-treeview.html">

<template id="template">
	<style>
		:host {
			display: block;
			position: relative;
			background: white;
			width: 400px;
			height: 300px;
		}
		#wrapper {
			display: flex;
    		flex-direction: column;
			width: 100%;
			height: 100%;
		}
		.main-content {
			width: 100%;
			flex-grow: 1;
			display: flex;
			max-height: 100%;
		}
		#script-list {
			width: 30%;
			min-width: 100px;
			margin-right: 2px;
			font-size: 12px;
			overflow-x: scroll;
		}
		textarea {
			width: 70%;
		}
		.toolbar {
			margin-top: 0.4rem;
		}
		.toolbar .bar-left {
			display: inline-block;
			text-align: left;
		}
		.toolbar .bar-right {
			float: right;
			display: inline-block;
			text-align: right;
		}
	</style>
	
	<div id="wrapper">
		<div class="main-content">
			<lively-treeview id="script-list">
				<ul>
					<li class="node collapsed">
						<span class="leaf">Properties</span>
						<ul id="property-nodes">
							<!--<li><span class="leaf">Property 1</span></li>
							<li><span class="leaf">Property 2</span></li>
							<li><span class="leaf">Property 3</span></li>
							<li><span class="leaf">Property 4</span></li>-->
						</ul>
					</li>
					<li class="node">
						<span class="leaf">Scripts</span>
						<ul id="script-nodes">
							
						</ul>
					</li>
				</ul>
			</lively-treeview>
			<textarea id="editor"></textarea>
		</div>
		<div class="toolbar">
			<div class="bar-left">
				<button id="add-script">Add</button>
				<button id="remove-script">Remove</button>
			</div>
			<div class="bar-right">
				<button id="save-script">Save</button>
			</div>
		</div>
	</div>
</template>

<script>
	'use strict';

	class ObjectEditor extends HTMLDivElement {

		get target() {
			return this._target;
		}
		
		set target(val) {
			this._target = val;
			this.title = val.tagName;
			this.render();
		}
		
		attachedCallback() {
			console.log('editor attachedCallback!');
			this.attached = true;
		
			this.scriptList = this.shadowRoot.querySelector('#script-list');
			this.editor = this.shadowRoot.querySelector('#editor');
			this.addButton = this.shadowRoot.querySelector('#add-script');
			this.removeButton = this.shadowRoot.querySelector('#remove-script');
			this.saveButton = this.shadowRoot.querySelector('#save-script');
		
			this.scriptList.addEventListener('change', (e) => { this.scriptChanged(e) });
			this.addButton.addEventListener('click', (e) => { this.addButtonClicked(e) });
			this.removeButton.addEventListener('click', (e) => { this.removeButtonClicked(e) });
			this.saveButton.addEventListener('click', (e) => { this.saveButtonClicked(e) });
		
			this.render();
		}
		
		render() {
			console.log('editor render!');
			if (!this.attached) {
				return;
			}
		
			// Scripts
			this.updateScripts();
		}
		
		addButtonClicked(e) {
			if (!this.target) {
				return;
			}
		
			if (typeof this.target.__scripts__ === 'undefined') {
				this.target.__scripts__ = {};
			}
		
			var scriptName = prompt('Please enter a new script name', '');
			if (!scriptName || scriptName.length <= 0) {
				return;
			}
		
			if (typeof this.target.__scripts__[scriptName] !== 'undefined') {
				alert('Script name already in use.');
				return;
			}
		
			scriptManager.addScript(this.target, 'function ' + scriptName + '() {\n  \n}');
			this.updateScripts();
			this.scriptList.selectLeaf(this.scriptList.querySelector('.leaf[data-script-name="'+scriptName+'"]'));
			this.scriptChanged();
		}
		
		removeButtonClicked(e) {
			if (this.target) {
				if (this.scriptList.activeLeaf !== null) {
					let scriptName = this.scriptList.activeLeaf.dataset['scriptName'];
					scriptManager.removeScript(this.target, scriptName);
				}
				this.editor.value = '';
				this.updateScripts();
			}
		}
		
		saveButtonClicked(e) {
			if (this.target && this.scriptList.activeLeaf !== null) {
				let scriptName = this.scriptList.activeLeaf.dataset['scriptName'];
				scriptManager.updateScript(this.target, this.editor.value, { name: scriptName });
			}
		}
		
		scriptChanged(e) {
			if (this.scriptList.activeLeaf !== null) {
				var scriptName = this.scriptList.activeLeaf.dataset['scriptName'];
				this.loadScript(scriptName);
			} else {
				this.editor.value = '';
			}
		}
		
		loadScript(scriptName) {
			if (typeof this.target.__scripts__ === 'undefined' ||
				typeof this.target.__scripts__[scriptName] === 'undefined') {
				return;
			}
			this.shadowRoot.querySelector('#editor').value = this.target.__scripts__[scriptName];
		}
		
		updateScripts() {
			let scriptHtml = '';
			if (this.target && typeof this.target.__scripts__ !== 'undefined') {
				for (let scriptName in this.target.__scripts__) {
					scriptHtml += '<li><span class="leaf" data-script-name="' + scriptName + '">' + scriptName + '</span></li>';
				}
			}
			this.shadowRoot.querySelector('#script-nodes').innerHTML = scriptHtml;
		}
	}

	(function() {
		ObjectEditor.template = document.currentScript.ownerDocument.querySelector('#template');
		var clone = document.importNode(ObjectEditor.template.content, true);
		var prototype = Object.create(ObjectEditor.prototype);
		
		System.import('../src/client/morphic/component-loader.js').then(loader => { loader.register('lively-object-editor', clone, prototype); });
	})();
</script>