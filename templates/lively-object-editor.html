<link rel="import" href="lively-treeview.html">

<template id="template">
	<style>
		:host {
			display: block;
			position: relative;
			background: white;
			width: 400px;
			height: 300px;
		}
		#wrapper {
			display: flex;
    		flex-direction: column;
			width: 100%;
			height: 100%;
		}
		.main-content {
			width: 100%;
			flex-grow: 1;
			display: flex;
			max-height: 100%;
		}
		#property-list {
			width: 30%;
			min-width: 100px;
			margin-right: 2px;
			font-size: 12px;
			overflow-x: scroll;
		}
		textarea {
			width: 70%;
		}
		.toolbar {
			margin-top: 0.4rem;
		}
		.toolbar .bar-left {
			display: inline-block;
			text-align: left;
		}
		.toolbar .bar-right {
			float: right;
			display: inline-block;
			text-align: right;
		}
	</style>

	<div id="wrapper">
		<div class="main-content">
			<lively-treeview id="property-list">
				<ul>
					<li class="node">
						<span class="leaf">Scripts</span>
						<ul id="script-nodes"></ul>
					</li>
					<li class="node">
						<span class="leaf">Attributes</span>
						<ul id="attribute-nodes"></ul>
					</li>
					<li class="node collapsed">
						<span class="leaf">Properties</span>
						<ul id="property-nodes"></ul>
					</li>
				</ul>
			</lively-treeview>
			<textarea id="editor"></textarea>
		</div>
		<div class="toolbar">
			<div class="bar-left">
				<button id="add-script">Add</button>
				<button id="remove-script">Remove</button>
			</div>
			<div class="bar-right">
				<button id="save-script">Save</button>
			</div>
		</div>
	</div>
</template>

<script>
	'use strict';
	
	var generateUUID;

	class ObjectEditor extends HTMLDivElement {
		/* 
		 * HTMLElement callbacks 
		 */
		attachedCallback() {
			console.log('editor attachedCallback!');
			this.attached = true;

			this.propertyList = this.shadowRoot.querySelector('#property-list');
			this.editor = this.shadowRoot.querySelector('#editor');
			this.addButton = this.shadowRoot.querySelector('#add-script');
			this.removeButton = this.shadowRoot.querySelector('#remove-script');
			this.saveButton = this.shadowRoot.querySelector('#save-script');

			this.propertyList.addEventListener('change', (e) => { this.listChanged(e) });
			this.addButton.addEventListener('click', (e) => { this.addButtonClicked(e) });
			this.removeButton.addEventListener('click', (e) => { this.removeButtonClicked(e) });
			this.saveButton.addEventListener('click', (e) => { this.saveButtonClicked(e) });

			if (this.attributes['target']) {
				let target = this.attributes['target'].value;
				if (target[0] !== '#') {
					console.warn('ObjectEditor: Invalid target. Currently, only #IDs are supported.');
				} else {
					let el = document.getElementById(target.substr(1));
					if (el) {
						this.target = el;
						return;
					}
					console.warn('ObjectEditor: Could not find target ' + target);
				}
			}

			this.render();
		}
		
		detachedCallback() {
			console.log('editor detachedCallback');
			if (this.target) {
				this.destroyObservers();
			}
		}

		// Target element
		get target() {
			return this._target;
		}

		set target(val) {
			if (this.target) {
				this.destroyObservers();
			}
			
			this._target = val;
			this.title = val.tagName;
			this.render();
			
			if (typeof this.target.__scripts__ === 'undefined') {
				this.target.__scripts__ = {};
			}
			
			if (this.target.id.length > 0) {
				$(this).attr('target', '#' + this.target.id);
			} else {
				$(this.target).attr('data-lively-id', generateUUID());
			}
			
			this.createObservers();
		}
		
		/*
		 * Observers for attributes, scripts, etc.
		 */
		createObservers() {
			this.scriptsObserverWrapper = this.scriptsObserver.bind(this);
			Object.observe(this.target.__scripts__, this.scriptsObserverWrapper);
			
			this.domObserver = new MutationObserver((changes) => { this.attributesObserver(changes) });
			this.domObserver.observe(this.target, {
				attributes: true
			});
		}
		destroyObservers() {
			Object.unobserve(this.target.__scripts__, this.scriptsObserverWrapper);
			this.domObserver.disconnect();
		}
		
		attributesObserver(changes) {
			/*changes.forEach(function(change, i) {
				console.log(change);
			});*/
			this.updateAttributes();
		}
		scriptsObserver(changes) {
			/*changes.forEach(function(change, i) {
				console.log(change);
			});*/
			this.updateScripts();
		}

		render() {
			console.log('editor render!');
			if (!this.attached) {
				return;
			}

			this.updateList();
		}

		addButtonClicked(e) {
			if (!this.target) {
				return;
			}

			if (typeof this.target.__scripts__ === 'undefined') {
				this.target.__scripts__ = {};
			}

			var scriptName = prompt('Please enter a new script name', '');
			if (!scriptName || scriptName.length <= 0) {
				return;
			}

			if (typeof this.target.__scripts__[scriptName] !== 'undefined') {
				alert('Script name already in use.');
				return;
			}

			scriptManager.addScript(this.target, 'function ' + scriptName + '() {\n  \n}');
			this.updateScripts();
			this.propertyList.selectLeaf(this.propertyList.querySelector('.leaf[data-script-name="'+scriptName+'"]'));
			this.listChanged();
		}

		removeButtonClicked(e) {
			if (this.target) {
				if (this.propertyList.activeLeaf !== null) {
					let scriptName = this.propertyList.activeLeaf.dataset['scriptName'];
					scriptManager.removeScript(this.target, scriptName);
				}
				this.editor.value = '';
				this.updateScripts();
			}
		}

		saveButtonClicked(e) {
			if (this.target && this.propertyList.activeLeaf !== null) {
				let scriptName = this.propertyList.activeLeaf.dataset['scriptName'];
				scriptManager.updateScript(this.target, this.editor.value, { name: scriptName });
			}
		}

		listChanged(e) {
			if (this.propertyList.activeLeaf !== null) {
				let data = this.propertyList.activeLeaf.dataset;

				if (typeof data['scriptName'] !== 'undefined') {
					this.loadScript(data['scriptName']);
				} else if (typeof data['attributeName'] !== 'undefined') {
					this.loadAttribute(data['attributeName']);
				}
			} else {
				this.editor.value = '';
			}
		}

		loadScript(scriptName) {
			if (typeof this.target.__scripts__ === 'undefined' ||
				typeof this.target.__scripts__[scriptName] === 'undefined') {
				return;
			}
			this.shadowRoot.querySelector('#editor').value = this.target.__scripts__[scriptName];
		}
		loadAttribute(attributeName) {
			this.editor.value = this.target.attributes[attributeName].value;
		}

		updateList() {
			this.updateScripts();
			this.updateAttributes();
			// this.updateProperties();
		}

		updateScripts() {
			let scriptHtml = '';
			if (this.target && typeof this.target.__scripts__ !== 'undefined') {
				for (let scriptName in this.target.__scripts__) {
					scriptHtml += '<li><span class="leaf" data-script-name="' + scriptName + '">' + scriptName + '</span></li>';
				}
			}
			this.shadowRoot.querySelector('#script-nodes').innerHTML = scriptHtml;
		}
		updateAttributes() {
			let html = '';
			if (this.target) {
				for (let i = 0; i < this.target.attributes.length; i++) {
					let attr = this.target.attributes[i];
					html += '<li><span class="leaf" data-attribute-name="' + attr.name + '">' + attr.name + '</span></li>';
				}
			}
			this.shadowRoot.querySelector('#attribute-nodes').innerHTML = html;
		}
	}

	(function() {
		ObjectEditor.template = document.currentScript.ownerDocument.querySelector('#template');
		var clone = document.importNode(ObjectEditor.template.content, true);
		var prototype = Object.create(ObjectEditor.prototype);

		System.import('../src/client/uuid.js').then(uuid => {
			console.log('uuid:', uuid);
			generateUUID = uuid.generateUUID;
		});
		System.import('../src/client/morphic/component-loader.js').then(loader => { loader.register('lively-object-editor', clone, prototype); });
	})();
</script>